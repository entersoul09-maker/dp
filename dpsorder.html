<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é”è­œä¼æ¥­ (è‚¡) æ¡ˆå ´è¨‚å–®ç³»çµ±</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #FDFDFB; 
            --text-color: #2C2C2C; 
            --accent-color: #FFB74D; 
            --done-color: #999999;
            --border-color: #E0E0DB;
            --white: #FFFFFF;
        }

        * { box-sizing: border-box; font-family: "Noto Sans TC", sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px; letter-spacing: 0.5px; }

        .container { max-width: 600px; margin: 0 auto; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid var(--accent-color); margin-bottom: 15px; 
        }
        header h1 { font-size: 1.1rem; font-weight: 500; margin: 0; flex-grow: 1; text-align: center; padding-left: 40px; }
        .btn-share-top { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }

        /* æ—¥æ›†æ¨£å¼ */
        .calendar-card { background: var(--white); border: 1px solid var(--border-color); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .cal-day-head { font-size: 0.7rem; color: #888; padding-bottom: 5px; }
        .cal-date { 
            padding: 8px 0; font-size: 0.85rem; border-radius: 4px; position: relative; cursor: pointer; 
            min-height: 40px; display: flex; flex-direction: column; align-items: center;
        }
        .cal-date.today { background: #f0f0f0; font-weight: bold; }
        .cal-date.has-event::after {
            content: ''; width: 5px; height: 5px; background: var(--accent-color); border-radius: 50%;
            position: absolute; bottom: 5px;
        }
        .event-tip { font-size: 0.75rem; color: #E67E22; margin-top: 10px; padding: 8px; background: #FFF9F0; border-radius: 4px; display: none; }

        /* è¡¨å–®æ¨£å¼ */
        .card { background: var(--white); padding: 20px; border-radius: 2px; border: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.02); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 6px; color: #666; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background: var(--bg-color); }
        
        .palette-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 5px; }
        .palette-item { padding: 6px 2px; border: 1px solid #eee; background: #fff; cursor: pointer; text-align: center; font-size: 0.7rem; min-height: 45px; display: flex; align-items: center; justify-content: center; }
        .palette-item.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        .ship-box { background: #FFF9F0; border: 1px solid var(--accent-color); padding: 12px; border-radius: 4px; }
        
        /* è¨‚å–®é …ç›® */
        .order-item { background: #FFF; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border-color); position: relative; }
        .order-item.status-closed { background: #F5F5F5; opacity: 0.7; }
        .order-item.status-closed .order-title, .order-item.status-closed .order-info, .order-item.status-closed .order-tag { 
            text-decoration: line-through; color: var(--done-color); 
        }
        
        .order-title { font-size: 1rem; font-weight: bold; border-left: 4px solid var(--accent-color); padding-left: 10px; margin-bottom: 5px; }
        .order-info { font-size: 0.8rem; color: #555; line-height: 1.5; }
        .order-tag { display: inline-block; background: var(--accent-color); color: white; padding: 2px 8px; font-size: 0.75rem; margin-top: 8px; }
        
        .action-btns { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .btn-sm { padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer; border: 1px solid #ddd; background: #fff; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--text-color); color: white; border: none; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .btn-cancel { width: 100%; padding: 10px; background: #fff; border: 1px solid var(--text-color); margin-top: 5px; cursor: pointer; }
        .search-bar { width: 100%; padding: 10px; border: 1px solid var(--border-color); margin-bottom: 15px; border-radius: 20px; text-align: center; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>é”è­œä¼æ¥­æ¡ˆå ´ç³»çµ±</h1>
        <button class="btn-share-top" onclick="shareSite()"><span>ğŸ“¤</span></button>
    </header>

    <div class="calendar-card">
        <div class="calendar-header">
            <span onclick="changeMonth(-1)" style="cursor:pointer">â—€</span>
            <span id="calendarMonth">å¹´ æœˆ</span>
            <span onclick="changeMonth(1)" style="cursor:pointer">â–¶</span>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div id="eventTip" class="event-tip"></div>
    </div>

    <div class="card" id="inputSection">
        <input type="hidden" id="editingId">
        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label>æ¡ˆå ´åç¨±</label><input type="text" id="siteName"></div>
            <div><label>è² è²¬äºº</label><input type="text" id="manager"></div>
        </div>
        <div class="form-group"><label>èµ·å§‹æ—¥æœŸ (ä¸‹å–®æ—¥)</label><input type="date" id="startDate" onchange="autoCalc()"></div>
        <div class="form-group">
            <label>è‰²æ¿æ¬¾å¼ (å¯è¤‡é¸)</label>
            <div class="palette-grid" id="paletteGrid"></div>
            <input type="text" id="selectedColorDisplay" readonly style="margin-top:5px; font-size:0.7rem; border:none; color:#888;" placeholder="æœªé¸å–è‰²æ¿">
        </div>
        <div class="form-group"><label>è‰²æ¿ç‹€æ³</label><input type="text" id="note" placeholder="ç´€éŒ„é€²åº¦..."></div>
        <div class="form-group ship-box">
            <label>æœ€çµ‚å‡ºè²¨æ—¥ (æ’é™¤å…­æ—¥)</label>
            <input type="date" id="shipDate" onchange="validateWeekday(this)">
        </div>
        <button class="btn-main" id="saveBtn" onclick="saveOrder()">ä¿å­˜è¨‚å–®ç´€éŒ„</button>
        <button class="btn-cancel" id="cancelBtn" style="display:none;" onclick="resetForm()">å–æ¶ˆä¿®æ­£</button>
    </div>

    <input type="text" id="search" class="search-bar" placeholder="ğŸ” æœå°‹æ¡ˆå ´åç¨±..." oninput="renderOrders()">
    <div id="orderList"></div>
    
    <div style="text-align:center; padding: 20px 0;">
        <button onclick="exportExcel()" style="background:none; border:1px solid #ccc; padding:10px 20px; font-size:0.8rem">åŒ¯å‡º Excel å ±è¡¨</button>
    </div>
</div>

<script>
    const paletteData = [
        {id:"D317A", name:"æ°´è—"}, {id:"D321A", name:"éµç°"}, {id:"D322A", name:"å°¼ç¾…æ²³ç¶ "},
        {id:"D301B", name:"é»‘ç¹”ç´—"}, {id:"D302B", name:"ç°ç¹”ç´—"}, {id:"D395B", name:"å¸ƒç´‹æ£•"},
        {id:"D1060B", name:"æ³¢çˆ¾å¤šé›ªæ¾"}, {id:"D1122B", name:"é¢¨åŒ–ç¢³æœ¨"}, {id:"D1183B", name:"åŒ—ç¾åŸæ©¡"},
        {id:"D1185B", name:"å†°å³¶ç™½æ©¡"}, {id:"D1187B", name:"å‡¡çˆ¾è³½æ©¡æœ¨"}, {id:"D1348", name:"æ´—ç™½æ©¡æœ¨"},
        {id:"D1370B", name:"æ©¡æœ¨æ´—ç™½"}, {id:"D2091B", name:"ä¸¹éº¥æ«¸æœ¨"}, {id:"D2415B", name:"å®‰è—¤æ¸…æ°´æ¨¡"},
        {id:"D3183B", name:"ç‘å…¸ç°æ¦†"}, {id:"D5007B", name:"æ‘©å¡æŸšæœ¨"}, {id:"D6357B", name:"ç™½é›²å²©"},
        {id:"D6358B", name:"æ³¥ç°å²©"}, {id:"D371B", name:"å°ç£æŸšæœ¨"}, {id:"D373B", name:"å¤å…¸æ¦†æœ¨"},
        {id:"D376B", name:"æ›‰ç°æ¦†æœ¨"}, {id:"D3381B", name:"æœ­æ‹‰æ·ºæ©¡"}, {id:"D3383B", name:"æœ­æ‹‰ç°æ©¡"},
        {id:"D6590C", name:"å¥¶èŒ¶ç±³"}, {id:"D9058C", name:"åŒ—æ­ç™½æ ¸æ¡ƒ"}, {id:"D6000C", name:"çç ç™½"},
        {id:"D6000SC", name:"é›ªç™½ç´‹"}, {id:"D702C", name:"è±¡ç‰™ç°"}, {id:"D552C", name:"è‰¾å¤æ«šæœ¨"},
        {id:"D555C", name:"ç²‰æœµæ‹‰æ«šæœ¨"}, {id:"-", name:"å¤–è¨‚ç‰ˆ"}, {id:"ETC", name:"å…¶ä»–"}
    ];

    let orders = JSON.parse(localStorage.getItem('dapu_v12_data')) || [];
    let selectedColors = new Set();
    let currentCalDate = new Date();

    function init() {
        const grid = document.getElementById('paletteGrid');
        grid.innerHTML = paletteData.map(c => `
            <div class="palette-item" id="p-${c.id}" onclick="toggleColor('${c.id}','${c.name}')">
                ${c.name}<br>${c.id}
            </div>
        `).join('');
        document.getElementById('startDate').valueAsDate = new Date();
        autoCalc();
        renderCalendar();
        renderOrders();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('calendarMonth');
        grid.innerHTML = '';
        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        monthLabel.innerText = `${year}å¹´ ${month + 1}æœˆ`;

        const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        days.forEach(d => grid.innerHTML += `<div class="cal-day-head">${d}</div>`);

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const isToday = new Date().toISOString().split('T')[0] === dateStr;
            const hasEvent = orders.some(o => o.ship === dateStr && !o.isClosed);
            grid.innerHTML += `
                <div class="cal-date ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}" onclick="showDayEvents('${dateStr}')">
                    ${d}
                </div>
            `;
        }
    }

    function showDayEvents(dateStr) {
        const dayOrders = orders.filter(o => o.ship === dateStr && !o.isClosed);
        const tip = document.getElementById('eventTip');
        if (dayOrders.length > 0) {
            tip.style.display = 'block';
            tip.innerHTML = `ğŸ“… <strong>${dateStr} å‡ºè²¨ï¼š</strong><br>` + dayOrders.map(o => `â€¢ ${o.site}`).join('<br>');
        } else { tip.style.display = 'none'; }
    }

    function changeMonth(dir) {
        currentCalDate.setMonth(currentCalDate.getMonth() + dir);
        renderCalendar();
    }

    function toggleColor(id, name) {
        const displayLabel = (id === 'ETC') ? 'å…¶ä»–' : `${id} ${name}`;
        if (selectedColors.has(displayLabel)) {
            selectedColors.delete(displayLabel);
            document.getElementById(`p-${id}`).classList.remove('selected');
        } else {
            selectedColors.add(displayLabel);
            document.getElementById(`p-${id}`).classList.add('selected');
        }
        document.getElementById('selectedColorDisplay').value = Array.from(selectedColors).join(', ');
    }

    function autoCalc() {
        let date = new Date(document.getElementById('startDate').value);
        if (isNaN(date.getTime())) return;
        let count = 0;
        while (count < 6) {
            date.setDate(date.getDate() + 1);
            if (date.getDay() !== 0 && date.getDay() !== 6) count++;
        }
        document.getElementById('shipDate').valueAsDate = date;
    }

    function validateWeekday(input) {
        let selected = new Date(input.value);
        let day = selected.getDay();
        if (day === 0 || day === 6) {
            selected.setDate(selected.getDate() + (day === 6 ? 2 : 1));
            input.valueAsDate = selected;
        }
    }

    function saveOrder() {
        const site = document.getElementById('siteName').value;
        const editingId = document.getElementById('editingId').value;
        if(!site) return alert("è«‹è¼¸å…¥æ¡ˆå ´åç¨±");

        const order = {
            id: editingId ? parseInt(editingId) : Date.now(),
            site: site, manager: document.getElementById('manager').value,
            start: document.getElementById('startDate').value,
            colors: document.getElementById('selectedColorDisplay').value,
            note: document.getElementById('note').value,
            ship: document.getElementById('shipDate').value,
            isClosed: false
        };

        if(editingId) {
            const idx = orders.findIndex(o => o.id === order.id);
            order.isClosed = orders[idx].isClosed;
            orders[idx] = order;
        } else { orders.unshift(order); }
        
        localStorage.setItem('dapu_v12_data', JSON.stringify(orders));
        resetForm(); renderCalendar(); renderOrders();
    }

    function editOrder(id) {
        const o = orders.find(x => x.id === id);
        if(o.isClosed) return;
        document.getElementById('editingId').value = o.id;
        document.getElementById('siteName').value = o.site;
        document.getElementById('manager').value = o.manager;
        document.getElementById('startDate').value = o.start;
        document.getElementById('note').value = o.note;
        document.getElementById('shipDate').value = o.ship;
        
        selectedColors.clear();
        document.querySelectorAll('.palette-item').forEach(i => i.classList.remove('selected'));
        if(o.colors) {
            const arr = o.colors.split(', ');
            arr.forEach(c => {
                selectedColors.add(c);
                let code = (c === 'å…¶ä»–') ? 'ETC' : c.split(' ')[0];
                const el = document.getElementById(`p-${code}`);
                if(el) el.classList.add('selected');
            });
        }
        document.getElementById('selectedColorDisplay').value = o.colors;
        document.getElementById('saveBtn').innerText = "ç¢ºèªä¿®æ­£";
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo({top:0, behavior:'smooth'});
    }

    function resetForm() {
        document.getElementById('editingId').value = "";
        document.getElementById('siteName').value = "";
        document.getElementById('manager').value = "";
        document.getElementById('note').value = "";
        document.getElementById('saveBtn').innerText = "ä¿å­˜è¨‚å–®ç´€éŒ„";
        document.getElementById('cancelBtn').style.display = "none";
        selectedColors.clear();
        document.querySelectorAll('.palette-item').forEach(i => i.classList.remove('selected'));
        document.getElementById('selectedColorDisplay').value = "";
        autoCalc();
    }

    function toggleStatus(id) {
        const idx = orders.findIndex(o => o.id === id);
        orders[idx].isClosed = !orders[idx].isClosed;
        localStorage.setItem('dapu_v12_data', JSON.stringify(orders));
        renderCalendar(); renderOrders();
    }

    function renderOrders() {
        const term = document.getElementById('search').value.toLowerCase();
        const container = document.getElementById('orderList');
        const filtered = orders.filter(o => o.site.toLowerCase().includes(term));
        container.innerHTML = filtered.map(o => `
            <div class="order-item ${o.isClosed ? 'status-closed' : ''}">
                <div class="action-btns">
                    ${!o.isClosed ? `<button class="btn-sm" style="color:#FFB74D" onclick="editOrder(${o.id})">ä¿®æ­£</button>` : ''}
                    <button class="btn-sm" onclick="toggleStatus(${o.id})">${o.isClosed ? 'æ¢å¾©' : 'çµæŸ'}</button>
                    <button class="btn-sm" onclick="deleteOrder(${o.id})">åˆª</button>
                </div>
                <div class="order-title">${o.site}</div>
                <div class="order-info">è² è²¬äººï¼š${o.manager} <br> å‡ºè²¨ï¼š${o.ship} <br> ç‹€æ³ï¼š${o.note}</div>
            </div>
        `).join('');
    }

    function deleteOrder(id) {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
            orders = orders.filter(o => o.id !== id);
            localStorage.setItem('dapu_v12_data', JSON.stringify(orders));
            renderCalendar(); renderOrders();
        }
    }

    function shareSite() {
        if (navigator.share) navigator.share({ title: 'é”è­œç³»çµ±', url: window.location.href });
        else alert("è«‹è¤‡è£½ç¶²å€åˆ†äº«");
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(orders);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è¨‚å–®");
        XLSX.writeFile(wb, `é”è­œæ¡ˆå ´å–®.xlsx`);
    }

    init();
</script>

</body>
</html>